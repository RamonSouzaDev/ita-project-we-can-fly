from src.ita_aero_sec.sensors.adsb import ADSBSensor
from src.ita_aero_sec.sensors.avionics import Arinc429Bus
import time
import sys

# CREA-SP Engineering Simulation
def run():
    print("Starting Engineering Simulation...")
    adsb = ADSBSensor()
    bus = Arinc429Bus()
    
    try:
        # Stream 50 seconds of flight data
        adsb_data = adsb.stream_flight_data(duration_sec=50, anomaly_prob=0.1)
        bus_data = bus.stream_bus_traffic(duration_cycles=50, injection_prob=0.05)
        
        cycle = 0
        for pkt, word in zip(adsb_data, bus_data):
            cycle += 1
            status = "[OK]"
            if pkt.is_spoofed: status = "[ALERT: SPOOF]"
            if word.is_injection: status = "[ALERT: INJECT]"
            
            # Dashboard
            output = f"Cycle {cycle:02d} | Alt: {pkt.altitude:.0f} | Vel: {pkt.velocity:.0f} | {status}      "
            sys.stdout.write("\r" + output)
            sys.stdout.flush()
            time.sleep(0.1)
            
    except KeyboardInterrupt:
        print("\nStopped.")

if __name__ == "__main__":
    run()
